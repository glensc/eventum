<form id="update_form" name="update_form" method="post" action="update.php">
<input type="hidden" name="cat" value="update">
<input type="hidden" name="issue_id" value="{{ issue.iss_id }}">
<input type="hidden" name="resolution" value="{{ issue.iss_res_id }}">
{% if core.current_role < core.roles.customer %}
<input type="hidden" name="keep_assignments" value="yes">
{% for sociated_issues in key=_issue_id item=_issue_summary from=issue. %}
<input type="hidden" name="associated_issues[]" value="{{ _issue_id }}">
{% endfor %}
<input type="hidden" name="estimated_dev_time" value="{$issue.iss_dev_time|escape:"html"}">
{% endif %}
<table id="issue_overview" class="bordered" data-issue-id="{{ issue_id }}">
<tr class="title">
    <th colspan="2">
        <b>{t}Update Issue Overview{/t}</b> (ID: <a href="{{ core.rel_url }}view.php?id={{ issue.iss_id }}" title="{t}view issue details{/t}">{{ issue.iss_id }}</a>)

        {% if core.current_role >= core.roles.developer %}
        &nbsp;<strong>Project:</strong>
        <select name="new_prj">
            {html_options options=$core.active_projects selected=$core.project_id}
        </select>
        <input type="submit" name="move_issue" value="{t}Move{/t}">
        {% endif %}
        <div id="issue_menu">
            {% if core.current_role > core.roles.customer %}
            [ <a class="link" title="{t}Edit the Reporter for this issue{/t}" href="edit_reporter.php?iss_id={{ issue_id }}">{t}Edit Reporter{/t}</a> ]
            [ <a title="{t}edit the authorized repliers list for this issue{/t}" href="authorized_replier.php?iss_id={{ issue_id }}" class="open_ar">{t}Edit Authorized Replier List{/t}</a> ]
            [ <a title="{t}edit the notification list for this issue{/t}" href="notification.php?iss_id={{ issue_id }}" class="open_nl">{t}Edit Notification List{/t}</a> ]
            {% endif %}
            [ <a title="{t}view the full history of changes on this issue{/t}" class="open_history" href="history.php?iss_id={{ issue_id }}">{t}History of Changes{/t}</a> ]
        </div>
    </th>
</tr>
<tr>
    <td class="grid_cell col0">
        <table class="grid">
            {% for row in grid[0] %}
            <tr>
                <th {% if isset(row.title_bgcolor) %}style="background-color: {{ row.title_bgcolor }}"{% endif %}>{{ row.title }}</th>
                <td {% if isset(row.data_bgcolor) %}style="background-color: {{ row.data_bgcolor }}"{% endif %}>
                {% if not isset(row.field) %}
                    {$row.data|escape:"html"}
                {% elseif row.field == 'category' %}
                    <select name="category">
                        {html_options options=$categories selected=$issue.iss_prc_id}
                    </select>
                {% elseif row.field == 'status' %}
                    <select name="status">
                        {html_options options=$status selected=$issue.iss_sta_id}
                    </select>
                {% elseif row.field == 'severity' %}
                    <select id="severity" name="severity">
                      <option value="-1">{t}Please choose a severity{/t}</option>
                      {% for severity in severities %}
                      <option value="{{ severity.sev_id }}" {% if severity.sev_id == issue.iss_sev_id|default('') %}selected{% endif %}
                        data-desc="{{ severity.sev_description|escape }}">{{ severity.sev_title|escape }}</option>
                      {% endfor %}
                    </select>
                {% elseif row.field == 'priority' %}
                    <select name="priority">
                        {html_options options=$priorities selected=$issue.iss_pri_id}
                    </select>
                {% elseif row.field == 'percentage_complete' %}
                    <input type="text" name="percentage_complete" value="{{ issue.iss_percent_complete }}" size="2">
                    {% include "error_icon.html.twig.html" with {'field' : 'percent_complete'} %}
                    <span>(0 - 100)</span>
                {% elseif row.field == 'product' %}
                    <select id="product" name="product[{$issue.products[0].ipv_id|default:0}]">
                        <option value="-1"></option>
                        {% for product in products %}
                        <option value="{{ product.pro_id }}" {% if product.pro_id == issue.products[0].pro_id|default('') %}selected{% endif %}
                        data-desc="{{ product.pro_version_howto|escape }}">{{ product.pro_title|escape }}</option>
                        {% endfor %}
                    </select>
                    {% include "error_icon.html.twig.html" with {'field' : 'product'} %}
                {% elseif row.field == 'product_version' %}
                    <input type="text" name="product_version[{$issue.products[0].ipv_id|default:0}]" value="{$issue.products[0].version|default:''}" size="20" />
                    <div id="product_version_howto"></div>
                    {% include "error_icon.html.twig.html" with {'field' : 'product_version'} %}
                {% elseif row.field == 'assignment' %}{% if issue.has_inactive_users %}
                    <span><label><input type="radio" name="keep_assignments" checked value="yes">{t}Keep Current Assignments{/t}: {{ issue.assignments }}</label>
                    <br />
                    <label><input type="radio" name="keep_assignments" value="no">{t}Change Assignments{/t}:</label> </span><br />
                    {% else %}
                    <input type="hidden" name="keep_assignments" value="no">
                    {% endif %}
                    <select id="assignments" size="{% if issue.has_inactive_users %}3{% else %}4{% endif %}" multiple name="assignments[]"
                            data-placeholder="{t}Choose Assignees...{/t}" class="chosen-select">
                        {% if issue.has_inactive_users %}
                        {html_options options=$users}
                        {% else %}
                        {html_options options=$users selected=$issue.assigned_users}
                        {% endif %}
                    </select>
                {% elseif row.field == 'scheduled_release' %}
                    <select name="scheduled_release">
                        <option value="0"></option>
                        {html_options options=$releases selected=$issue.iss_pre_id}
                    </select>
                {% elseif row.field == 'reporter' %}
                    <a href="list.php?reporter={{ issue.iss_usr_id }}&hide_closed=1">{$issue.reporter|escape:html}</a></div>
                {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </td>
    <td class="grid_cell col1">
        <table class="grid">
            {% for row in grid[1] %}
            <tr>
                <th {% if isset(row.title_bgcolor) %}style="background-color: {{ row.title_bgcolor }}"{% endif %}>{{ row.title }}</th>
                <td {% if isset(row.data_bgcolor) %}style="background-color: {{ row.data_bgcolor }}"{% endif %}>

                {% if in_array(row.field|default('',) array('iss_created_date', 'iss_updated_date')) %}
                  {{ row.data|timeago }}

                {% elseif not isset(row.field) %}
                  {$row.data|escape:"html"}

                {% elseif row.field|default('') == 'notification_list' %}
                    {% if subscribers.staff != '' %}{t}Staff{/t}: {$subscribers.staff|replace:"<":"&lt;"|replace:">":"&gt;"}{% endif %}
                    {% if subscribers.staff != '' and subscribers.customers != '' %}<br />{% endif %}
                    {% if subscribers.customers != '' %}{t}Other{/t}: {$subscribers.customers|replace:"<":"&lt;"|replace:">":"&gt;"}{% endif %}

                {% elseif row.field|default('') == 'expected_resolution' %}
                    <input type="text" name="expected_resolution_date" id="expected_resolution" value="{{ issue.iss_expected_resolution_date }}" class="date_picker">

                {% elseif row.field|default('') == 'duplicates' %}
                    {% if issue.iss_duplicated_iss_id %}
                    {t}Duplicate of{/t}: <a href="{{ core.rel_url }}view.php?id={{ issue.iss_duplicated_iss_id }}" title="{t}issue{/t} #{{ issue.iss_duplicated_iss_id }} ({$issue.duplicated_issue.current_status|escape:"html"}) - {$issue.duplicated_issue.title|escape:"html"}" class="{% if issue.duplicated_issue.is_closed %}closed{% endif %}">#{{ issue.iss_duplicated_iss_id }}</a>
                    {% endif %}
                    {% if issue.duplicates_details|@count > 0 %}
                    {% if issue.iss_duplicated_iss_id %}<br />{% endif %}
                    {t}Duplicated by{/t}:
                    {section name="i" loop=$issue.duplicates_details}
                    {strip}
                    <a href="{{ core.rel_url }}view.php?id={{ issue.duplicates_details[i].issue_id }}" title="{t}issue{/t} #{{ issue.duplicates_details[i].issue_id }} ({$issue.duplicates_details[i].current_status|escape:"html"}) - {$issue.duplicates_details[i].title|escape:"html"}" class="{% if issue.duplicates_details[i].is_closed %}closed{% endif %}">#{{ issue.duplicates_details[i].issue_id }}</a>
                    {% if not smarty.section.i.last %}, {% endif %}
                    {/strip}
                    {/section}
                    {% endif %}

                {% elseif row.field|default('') == 'authorized_repliers' %}
                    {% if issue.authorized_repliers.users|@count > 0 %}
                    {t}Staff{/t}:
                    {section name="replier" loop=$issue.authorized_repliers.users}
                    {strip}
                    {$issue.authorized_repliers.users[replier].replier|replace:"<":"&lt;"|replace:">":"&gt;"}
                    {% if smarty.section.replier.last != 1 %},&nbsp;{% endif %}
                    {/strip}
                    {/section}
                    <br />
                    {% endif %}
                    {% if issue.authorized_repliers.other|@count > 0 %}
                    {t}Other{/t}:
                    {section name="replier" loop=$issue.authorized_repliers.other}
                    {strip}
                    {$issue.authorized_repliers.other[replier].replier|replace:"<":"&lt;"|replace:">":"&gt;"}
                    {% if smarty.section.replier.last != 1 %},&nbsp;{% endif %}
                    {/strip}
                    {/section}
                    {% endif %}

                {% elseif row.field|default('') == 'customer_1' %}
                    {t}Support Level{/t}: {{ issue.contract.support_level }}
                    {% if issue.contract.options_display|default('') %}
                    <br />
                    {t}Support Options{/t}: {$issue.contract.options_display|default:''}
                    {% endif %}
                    {% if issue.customer.is_per_incident %}
                    <br />
                    {t}Redeemed Incident Types{/t}:
                    {strip}
                    {% for incident_details in issue.redeemed_incidents %}
                    {% if incident_details.is_redeemed == 1 %}
                    {% if not smarty.foreach.incident_loop.first %}, {% endif %}{{ incident_details.title }}
                    {% set has_redeemed_incident = '1' %}
                    {% endif %}
                    {% endfor %}
                    {/strip}
                    {% if has_redeemed_incident != 1 %}<i>{t}None{/t}</i>{% endif %}
                    {% endif %}

                {% elseif row.field == 'associated_issues' %}
                    {% include "include/issue_field.html.twig.html" with {'field_name' : 'associated_issues', 'form_name' : 'update_form', 'value' : ', ', 'join:$issue.associated_issues' : 'join:$issue.associated_issues'} %}

                {% elseif row.field == 'estimated_dev_time' %}
                    <input type="text" name="estimated_dev_time" value="{{ issue.iss_dev_time }}" size="4">
                    <span>({t}in hours{/t})</span>

                {% elseif row.field == 'group' %}
                    <select name="group">
                        <option value=""></option>
                        {html_options options=$groups selected=$issue.iss_grp_id}
                    </select>
                {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
    </td>
</tr>
<tr class="full_width">
    <td colspan="2">
        <table class="grid">
            <tr>
                <th>{t}Summary{/t}</th>
                <td>
                    <input type="text" size="60" name="summary" id="issue_summary" value="{$issue.iss_summary|escape:"html"}">
                    {% include "error_icon.html.twig.html" with {'field' : 'summary'} %}
                </td>
            </tr>
            <tr>
                <th class="initial_description">
                    {t}Description{/t}
                </th>
                <td>
                    {% if issue_lock %}
                    <div id="page_locked">
                        {t 1=$issue_lock.locker.usr_full_name 2=$issue_lock.expires_formatted_time escape=no}Page is locked by <b>%1</b>. Lock expires at %2{/t}
                    </div>

                    <span id="issue_description" {get_display_style element_name="issue_description"}>{$issue.iss_description|activateLinks:"link"|activateAttachmentLinks:$issue.iss_id}</span>
                    {% else %}
                    <textarea name="description" rows="20" style="width: 97%">{$issue.iss_original_description|escape:"html"}</textarea>
                    {% endif %}
                    {% include "error_icon.html.twig.html" with {'field' : 'description'} %}
                </td>
            </tr>

            {% include "edit_custom_fields.html.twig.html" with {'form_type' : 'edit'} %}

            {% if core.current_role > core.roles.standard_user %}
            <tr>
                <th>{t}Trigger Reminders{/t}</th>
                <td>
                        <label><input type="radio" name="trigger_reminders" value="1" {% if issue.iss_trigger_reminders %}checked{% endif %}>{t}Yes{/t}</label>
                        <label><input type="radio" name="trigger_reminders" value="0" {% if not issue.iss_trigger_reminders %}checked{% endif %}>{t}No{/t}</label>
                </td>
            </tr>
            {% else %}
            <input type="hidden" name="trigger_reminders" value="{{ issue.iss_trigger_reminders }}">
            {% endif %}

            {% if core.has_crm %}
            {% include "`$core.crm_template_path`/update_report_form_fields.html.twig.html" %}
            {% endif %}
        </table>
    </td>
</tr>

{% if core.current_role > core.roles.reporter %}
<tr class="buttons">
    <th colspan="2">
    {% if not issue_lock %}
    <input type="submit" value="{t}Update{/t}">
    {% endif %}
    <input type="submit" name="cancel" value="{t}Cancel Update{/t}">
    <input type="reset" value="{t}Reset{/t}">
    {% if (not issue.sta_is_closed) and core.current_role > core.roles.customer %}
    <div class="right">
        <input class="close_issue" type="button" value="{t}Close Issue{/t}">
    </div>
    {% endif %}
    </th>
</tr>
{% endif %}
</table>
</form>
